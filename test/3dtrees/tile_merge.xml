<tool id="3dtrees_tile_merge" name="3D Trees Tile and Merge" version="1.0.0">
    <description>Tile and merge 3D point cloud data for tree segmentation</description>
    <requirements>
        <container type="docker">ghcr.io/3dtrees-earth/3dtrees_tile_merge:latest</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python -u /src/run.py 
        --dataset-path '$input' 
        --output-dir .
        --task '$task'
        --tile-size '$tile_size'
        --overlap '$overlap'
    ]]>
    </command>
    <inputs>
        <param name="input" type="data" format="zip,binary" label="Input Point Cloud or ZIP file" help="Input LAS/LAZ point cloud file or ZIP file containing prepared files"/>
        <param name="task" type="select" label="Task" value="tile">
            <option value="tile">Tile (subsampling and tiling)</option>
            <option value="merge">Merge (merge tiles and remap to original resolution)</option>
        </param>
        <param name="tile_size" type="integer" value="50" label="Tile Size" help="Size of tiles in meters"/>
        <param name="overlap" type="integer" value="20" label="Overlap" help="Overlap between tiles in meters"/>
    </inputs>
    <outputs>
        <data name="output_tile" format="zip" label="Tiled Files" from_work_dir="prepared_files.zip">
            <filter>task == "tile"</filter>
        </data>
        <data name="output_merge" format="binary" label="Merged Point Cloud" from_work_dir="final_pc.laz">
            <filter>task == "merge"</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="input" value="test_pc_nopred.laz"/>
            <param name="task" value="tile"/>
            <param name="tile_size" value="50"/>
            <param name="overlap" value="20"/>
            <output name="output_tile" file="prepared_files.zip">
                <assert_contents>
                    <has_size value="0" delta="0" negate="true"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input" value="processed_files.zip"/>
            <param name="task" value="merge"/>
            <output name="output_merge" file="final_pc.laz">
            <assert_contents>
                    <has_size value="0" delta="0" negate="true"/>
                </assert_contents>
                </output>
        </test>
    </tests>
    <help>
        **What it does**
        This tool processes 3D point cloud data for tree segmentation by either:
        - Tiling: Subsampling the input point cloud and creating tiles for processing
        - Merging: Merging processed tiles back into the original point cloud resolution
        
        **Parameters**
        - Tile Size: Size of tiles in meters (default: 50)
        - Overlap: Overlap between tiles in meters (default: 20)
    </help>
    <citations>
        <citation type="bibtex">
            @misc{3dtrees_tile_merge, title = {3D Trees Tile and Merge Tool}, author = {3D Trees Project}, year = {2025}}
        </citation>
    </citations>
</tool>
